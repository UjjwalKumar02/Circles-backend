generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum PostType {
  NORMAL
  ANONYMOUS
  ANNOUNCEMENT
}

enum CommunityRole {
  MEMBER
  ADMIN
}

model User {
  id          Int               @id @default(autoincrement())
  googleId    String
  username    String            @unique
  email       String            @unique
  avatar      String?
  description String?
  memberships CommunityMember[]
  posts       Post[]
  likedPosts  Like[]
  comments    Comment[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Community {
  id          Int               @id @default(autoincrement())
  name        String            @unique
  slug        String            @unique
  description String?
  members     CommunityMember[]
  posts       Post[]
  createdAt   DateTime          @default(now())
}

model CommunityMember {
  id          Int           @id @default(autoincrement())
  userId      Int
  communityId Int
  role        CommunityRole @default(MEMBER)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
}

model Post {
  id          Int       @id @default(autoincrement())
  content     String
  type        PostType  @default(NORMAL)
  authorId    Int
  communityId Int
  likes       Like[]
  comments    Comment[]
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
}

model Like {
  id        Int  @id @default(autoincrement())
  postId    Int
  likedById Int
  post      Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  likedBy   User @relation(fields: [likedById], references: [id], onDelete: Cascade)

  @@unique([postId, likedById])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  postId    Int
  authorId  Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}
